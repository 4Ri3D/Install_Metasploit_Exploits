# Title: install_exploit v.1 - Install Metasploit Exploits
# Date: Sept. 27, 2017
# Author: Ethan Frazier
# Version: install_exploit v.1

#!/bin/usr/python3

from termcolor import colored
from os        import system, path
from sys       import argv
from argparse  import ArgumentParser


EXPLOITS_DIR = "~/.msf4/modules/exploits" # <----location of your exploit folder

def parse_args():
    ''' Create the arguments '''
    parser = ArgumentParser()
    parser.add_argument("-u", "--url_path", type=str,
                        help="Give a download link for the new exploit")
    parser.add_argument("-n", "--new_name", type=str,
                        help="Give a name for the new exploit")
    parser.add_argument("-e", "--file_extension", type=str,
                        help="Give a file extension")
    parser.add_argument("-c", "--category", type=str,
                        help="Give a category for the exploit")
    return parser.parse_args()

def does_exploit_dir_exist():
    ''' Checks to see if there is an 'exploits' directory already created  '''
    return path.isdir(EXPLOITS_DIR)

def does_category_exist():
    ''' Checks to see if a particular category exists in the 'exploits' directory '''
    args = parse_args()
    category = args.category

    if len(argv) == 1: # if there aren't any arguments
        no_arguments()
    else:              # continue with the program
        return (path.isdir(EXPLOITS_DIR+"/"+category), category)

def no_arguments():
    ''' Runs display info using --help if there are no arguments '''
    file_path = path.abspath('install_exploit.py')
    cmd = 'python3 '+file_path+' --help'
    system(cmd)

def add_to_metasploit_framework(category):
    ''' Takes in the path of the exploit we're going to copy and put into /usr/share/metasploit-framework '''

    args = parse_args()
    url_path = args.url_path
    new_name = args.new_name

    file_extension = args.file_extension
    file_with_extension = new_name + '.' + file_extension
    destination_path = EXPLOITS_DIR + '/' + category + '/' + file_with_extension
    download_command = 'wget -O '+ file_with_extension + ' ' + url_path
    grab_path = path.dirname(path.realpath(file_with_extension))
  
    system(download_command)                                       # download the file from the internet
    path_origin = grab_path + '/'  + file_with_extension           # grab the path origin
    mv_file_command = 'mv ' + path_origin + ' ' + destination_path
    system(mv_file_command)                                        # move the exploit file to the metasploit folder
    print(file_with_extension + ', has been successfully added to Metasploit!')

def main():
    ''' Main logic of the program '''
    system("clear")
    print(colored(("INSTALL METASPLOIT EXPLOITS v.1 by Ethan Frazier \n"), 'white'))

    if len(argv) == 1:
        no_arguments()
    else:
        if does_exploit_dir_exist():
            if does_category_exist():
                pass
            else:
                system("mkdir -p "+EXPLOITS_DIR + '/' + does_category_exist()[1])
        else:
            system("mkdir -p "+EXPLOITS_DIR)
            system("mkdir -p " + EXPLOITS_DIR + '/' + does_category_exist()[1])

        add_to_metasploit_framework(does_category_exist()[1])

if __name__ == '__main__':
    main()
