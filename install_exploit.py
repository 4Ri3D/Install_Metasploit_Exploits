#!/bin/usr/python3

# This will take in the path of the exploit we're going to copy and put into /usr/share/metasploit-framework

import os
import sys
import argparse

exploits_dir = "/root/.msf4/modules/exploits"

def parse_args():
    ''' Create the arguments '''
    parser = argparse.ArgumentParser(description='Take in some arguments')
    parser.add_argument("-u", "--url_path", type=str,
                        help="Give a download link for the new exploit")
    parser.add_argument("-n", "--new_name", type=str,
                        help="Give a name for the new exploit")
    parser.add_argument("-e", "--file_extension", type=str,
                        help="Give a file extension")
    parser.add_argument("-c", "--category", type=str,
                        help="Give a category for the exploit")
    return parser.parse_args()

def does_exploit_dir_exist():
    #exploits_dir = "/root/.msf4/modules/exploits"
    ''' Checks to see if there is an 'exploits' directory already created  '''
    return os.path.isdir(exploits_dir) # if you're running Kali
   # return os.path.isdir("$HOME/.msf4/modules/exploits")

def does_category_exist():
    ''' Checks to see if a particular category exists in the 'exploits' directory '''
    args = parse_args()
    category = args.category

    if len(sys.argv) == 1: # if there aren't any arguments
        no_arguments()
    else:                  # else, continue with the program
        return (os.path.isdir(exploits_dir+"/"+category), category)

def no_arguments():
    ''' This will run display info using --help if there are no arguments '''
    file_path = os.path.abspath('install_exploit.py')
    cmd = 'python3 '+file_path+' --help'
    print(cmd)
    os.system(cmd)

def add_to_metasploit_framework(category):
    ''' This will take in the path of the exploit we're going to copy and put into /usr/share/metasploit-framework '''
    # Declare the variables

    args = parse_args()
    url_path = args.url_path
    new_name = args.new_name

    file_extension = args.file_extension
    file_with_extension = new_name + '.' + file_extension
    destination_path = exploits_dir + '/' + category + '/' + file_with_extension
    download_command = 'wget -O '+ file_with_extension + ' ' + url_path
    grab_path = os.path.dirname(os.path.realpath(file_with_extension))
  
    # download the file from the internet

    os.system(download_command)
    
    # grab the path origin

    path_origin = grab_path + '/'  + file_with_extension

    mv_file_command = 'mv ' + path_origin + ' ' + destination_path

    # move the exploit file to the metasploit folder
    
    os.system(mv_file_command)

    print(file_with_extension + ', has been successfully added to Metasploit!')

def main():
    ''' Main logic of the program '''
    if len(sys.argv) == 1:
        no_arguments()
    else:
        if does_exploit_dir_exist():
            if does_category_exist():
                pass
            else:
                os.system("mkdir -p "+exploits_dir + '/' + does_category_exist()[1])
        else:
            os.system("mkdir -p "+exploits_dir)
            os.system("mkdir -p " + exploits_dir + '/' + does_category_exist()[1])

        add_to_metasploit_framework(does_category_exist()[1])

if __name__ == '__main__':
    main()
